<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milano Cortina 2026 | Contest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f1f5f9; scroll-behavior: smooth; }
        .ita-gradient { background: linear-gradient(90deg, #008C45 0%, #ffffff 50%, #CD212A 100%); }
        .active-a { background-color: #008C45 !important; color: white !important; border-color: #005c2d !important; }
        .active-b { background-color: #CD212A !important; color: white !important; border-color: #a01a21 !important; }
        .active-c { background-color: #004D99 !important; color: white !important; border-color: #003366 !important; }
        .active-field { background-color: #FFD700 !important; color: #000 !important; border-color: #bfa300 !important; }
        .card-ev { border-radius: 1.5rem; border-top: 6px solid #1e293b; transition: all 0.3s; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="antialiased text-slate-900 pb-10">

<div class="ita-gradient h-2 w-full fixed top-0 z-[100]"></div>

<nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200 shadow-sm h-20 flex items-center">
    <div class="max-w-7xl mx-auto px-4 w-full flex justify-between items-center">
        <div class="flex items-center gap-2">
            <span class="text-2xl">üáÆüáπ</span>
            <h1 class="font-black text-xl tracking-tighter uppercase">Milano Cortina <span class="text-red-600">2026</span></h1>
        </div>
        <button onclick="switchTab('admin')" class="px-5 py-2 rounded-xl font-bold text-[10px] text-slate-400 border border-slate-200 uppercase hover:bg-slate-50 transition">Admin Panel</button>
    </div>
</nav>

<div class="max-w-7xl mx-auto p-4 md:p-8">

    <div id="section-user">
        <div id="user-welcome" class="max-w-xl mx-auto mt-12 p-10 bg-white rounded-[3rem] shadow-2xl text-center space-y-8 border-b-8 border-green-600">
            <h2 class="text-4xl font-black uppercase italic leading-none text-slate-800">Pronto per <br>la sfida?</h2>
            <p class="text-slate-500 font-medium">Inserisci il tuo Nickname (emoji ammesse) per sbloccare i 116 eventi.</p>
            <input type="text" id="user-name" placeholder="Esempio: Bomber üèÖ" 
                   class="w-full bg-slate-50 border-4 border-slate-100 p-5 rounded-2xl focus:border-green-600 outline-none font-black text-2xl text-center shadow-inner">
            <button onclick="startGame()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xl hover:bg-black hover:scale-[1.02] transition-all shadow-xl uppercase tracking-widest">
                Gioca ora
            </button>
        </div>

        <div id="user-game" class="hidden space-y-10 animate-in fade-in duration-500">
            <div class="bg-white p-6 rounded-3xl shadow-lg border-l-8 border-red-600 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Atleta:</p>
                    <h3 id="display-name" class="text-2xl font-black italic text-slate-800"></h3>
                </div>
                <div class="flex flex-wrap justify-center gap-2">
                    <button onclick="autoFillContest()" class="px-4 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold text-[10px] uppercase hover:bg-amber-100 transition">ü§ñ Casuale</button>
                    <button onclick="downloadPDF()" class="px-4 py-3 rounded-xl bg-slate-900 text-white font-bold text-[10px] uppercase hover:bg-black transition">Scarica PDF</button>
                    <button onclick="generateCode()" class="px-6 py-3 rounded-xl bg-red-600 text-white font-black text-[10px] uppercase shadow-lg shadow-red-200 hover:bg-red-700 transition">Copia Codice Admin</button>
                </div>
            </div>
            <div id="events-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <div id="section-admin" class="hidden">
        <div id="admin-login" class="max-w-md mx-auto mt-20 p-8 bg-white rounded-3xl shadow-xl text-center space-y-4 border border-slate-200">
            <h2 class="font-black italic text-xl uppercase tracking-tighter text-slate-800">Accesso Admin üîê</h2>
            <input type="password" id="admin-pass" placeholder="Password" class="w-full p-4 border-2 rounded-xl text-center font-bold focus:border-red-500 outline-none transition-all">
            <button onclick="unlockAdmin()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-black transition-all">Entra nel Pannello</button>
            <button onclick="switchTab('user')" class="text-xs text-slate-400 hover:underline">Torna al Gioco</button>
        </div>

        <div id="admin-content" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-md border border-slate-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-black uppercase italic text-slate-800">Ranking</h3>
                        <button onclick="shareWhatsApp()" class="bg-green-100 text-green-700 px-3 py-1 rounded-lg font-bold text-[10px] uppercase hover:bg-green-200 transition">WhatsApp</button>
                    </div>
                    <div id="ranking-list" class="space-y-2"></div>
                </div>
                <div class="bg-slate-900 text-white p-6 rounded-3xl shadow-lg space-y-4">
                    <h4 class="text-[10px] font-black uppercase text-slate-500 tracking-widest">Configurazione Dati</h4>
                    <button onclick="document.getElementById('xl-in').click()" class="w-full py-3 bg-slate-800 rounded-xl font-bold text-[10px] uppercase border border-slate-700 hover:bg-slate-700 transition">1. Carica Excel</button>
                    <input type="file" id="xl-in" class="hidden" accept=".xlsx, .xls">
                    
                    <button onclick="exportDataForGitHub()" class="w-full py-3 bg-blue-600 rounded-xl font-bold text-[10px] uppercase shadow-lg shadow-blue-900 hover:bg-blue-500 transition">2. Genera Dati per GitHub</button>
                    
                    <textarea id="in-code" placeholder="Incolla codice partecipante..." class="w-full h-24 bg-slate-800 border-slate-700 rounded-xl p-3 text-[10px] font-mono outline-none focus:border-green-500"></textarea>
                    <button onclick="importUser()" class="w-full py-3 bg-green-600 rounded-xl font-bold text-[10px] uppercase hover:bg-green-500 transition shadow-lg shadow-green-900">3. Importa Partecipante</button>
                    
                    <button onclick="resetAllData()" class="w-full py-2 text-[9px] text-red-400 font-bold hover:underline">ELIMINA TUTTO (Reset Totale)</button>
                </div>
            </div>
            <div class="lg:col-span-8 bg-white p-8 rounded-3xl shadow-md border border-slate-100">
                <h3 class="font-black uppercase italic mb-6 text-slate-800 border-b pb-4">Gestione Esiti & Pronostici</h3>
                <div id="admin-events-list" class="space-y-6 max-h-[800px] overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================================
// ‚ö†Ô∏è INCOLLA QUI I DATI TRA LE PARENTESI QUADRE ‚ö†Ô∏è
const DATI_FISSI = [[{"id":1,"date":"07/02/2026","sport":"alpine skiing","name":"men's downhill","a":"","b":"","c":"","field":"PICKING #field"},{"id":2,"date":"11/02/2026","sport":"alpine skiing","name":"men's super-G","a":"Marco Odermatt (SUI)","b":"Vincent Kriechmayr","c":"Franjo Von Allmen","field":"PICKING #field"},{"id":3,"date":"14/02/2026","sport":"alpine skiing","name":"men's giant slalom","a":"Marco Odermatt (SUI)","b":"Alex Steen Olsen","c":"Loic Meillard","field":"PICKING #field"},{"id":4,"date":"16/02/2026","sport":"alpine skiing","name":"men's slalom","a":"Clement Noel (FRA)","b":"Lucas Pinheiro Braathen (BRA)","c":"Atle Lie McGrath","field":"PICKING #field"},{"id":5,"date":"09/02/2026","sport":"alpine skiing","name":"men's team combined","a":"","b":"","c":"","field":"PICKING #field"},{"id":6,"date":"08/02/2026","sport":"alpine skiing","name":"women's downhill","a":"Sofia Goggia (ITA)","b":"Lindsey Vonn (USA)","c":"Cornelia Huetter","field":"PICKING #field"},{"id":7,"date":"12/02/2026","sport":"alpine skiing","name":"women's super-G","a":"","b":"","c":"","field":"PICKING #field"},{"id":8,"date":"15/02/2026","sport":"alpine skiing","name":"women's giant slalom","a":"","b":"","c":"","field":"PICKING #field"},{"id":9,"date":"18/02/2026","sport":"alpine skiing","name":"women's slalom","a":"Mikaela Shiffrin (USA)","b":"Camille Rast","c":"Zrinka Ljutic","field":"PICKING #field"},{"id":10,"date":"10/02/2026","sport":"alpine skiing","name":"women's team combined","a":"","b":"","c":"","field":"PICKING #field"},{"id":11,"date":"13/02/2026","sport":"biathlon","name":"men's 10km sprint","a":"","b":"","c":"","field":"PICKING #field"},{"id":12,"date":"10/02/2026","sport":"biathlon","name":"men's 20km individual","a":"","b":"","c":"","field":"PICKING #field"},{"id":13,"date":"15/02/2026","sport":"biathlon","name":"men's 12,5km pursuit","a":"","b":"","c":"","field":"PICKING #field"},{"id":14,"date":"20/02/2026","sport":"biathlon","name":"men's 15km mass start","a":"","b":"","c":"","field":"PICKING #field"},{"id":15,"date":"17/02/2026","sport":"biathlon","name":"men's 4x7,5km relay","a":"NORVEGIA","b":"FRANCIA","c":"SVEZIA","field":"PICKING #field"},{"id":16,"date":"14/02/2026","sport":"biathlon","name":"women's 7,5km sprint","a":"","b":"","c":"","field":"PICKING #field"},{"id":17,"date":"11/02/2026","sport":"biathlon","name":"women's 15km individual","a":"","b":"","c":"","field":"PICKING #field"},{"id":18,"date":"15/02/2026","sport":"biathlon","name":"women's 10km pursuit","a":"","b":"","c":"","field":"PICKING #field"},{"id":19,"date":"21/02/2026","sport":"biathlon","name":"women's 12,5km mass start","a":"","b":"","c":"","field":"PICKING #field"},{"id":20,"date":"18/02/2026","sport":"biathlon","name":"women's 4x6km relay","a":"FRANCIA","b":"SVEZIA","c":"NORVEGIA","field":"PICKING #field"},{"id":21,"date":"08/02/2026","sport":"biathlon","name":"mixed relay 4x6km (W+M)","a":"","b":"","c":"","field":"PICKING #field"},{"id":22,"date":"17/02/2026","sport":"bobsleigh","name":"2-man","a":"Francesco Friedrich (GER)","b":"Johannes Lochner (GER)","c":"Adam Ammour (GER)","field":"PICKING #field"},{"id":23,"date":"22/02/2026","sport":"bobsleigh","name":"4-man","a":"Johannes Lochner (GER)","b":"Francesco Friedrich (GER)","c":"","field":"PICKING #field"},{"id":24,"date":"16/02/2026","sport":"bobsleigh","name":"women's monobob","a":"Laura Nolte (GER)","b":"Kaysha Love (USA)","c":"Lisa Buckwitz (GER)","field":"PICKING #field"},{"id":25,"date":"21/02/2026","sport":"bobsleigh","name":"2-women","a":"Laura Nolte (GER)","b":"Kim Kalicki (GER)","c":"Lisa Buckwitz (GER)","field":"PICKING #field"},{"id":26,"date":"08/02/2026","sport":"cross-country","name":"men's skiathlon","a":"","b":"","c":"","field":"PICKING #field"},{"id":27,"date":"10/02/2026","sport":"cross-country","name":"men's sprint classic","a":"","b":"","c":"","field":"PICKING #field"},{"id":28,"date":"18/02/2026","sport":"cross-country","name":"men's team sprint free","a":"","b":"","c":"","field":"PICKING #field"},{"id":29,"date":"15/02/2026","sport":"cross-country","name":"men's 4x7,5km relay","a":"","b":"","c":"","field":"PICKING #field"},{"id":30,"date":"13/02/2026","sport":"cross-country","name":"men's 10km free","a":"","b":"","c":"","field":"PICKING #field"},{"id":31,"date":"21/02/2026","sport":"cross-country","name":"men's 50km mass start","a":"","b":"","c":"","field":"PICKING #field"},{"id":32,"date":"07/02/2026","sport":"cross-country","name":"women's skiathlon","a":"","b":"","c":"","field":"PICKING #field"},{"id":33,"date":"10/02/2026","sport":"cross-country","name":"women's sprint classic","a":"","b":"","c":"","field":"PICKING #field"},{"id":34,"date":"18/02/2026","sport":"cross-country","name":"women's team sprint free","a":"","b":"","c":"","field":"PICKING #field"},{"id":35,"date":"14/02/2026","sport":"cross-country","name":"women's 4x7,5km relay","a":"","b":"","c":"","field":"PICKING #field"},{"id":36,"date":"12/02/2026","sport":"cross-country","name":"women's 10km free","a":"","b":"","c":"","field":"PICKING #field"},{"id":37,"date":"21/02/2026","sport":"cross-country","name":"women's 50km mass start","a":"","b":"","c":"","field":"PICKING #field"},{"id":38,"date":"21/02/2026","sport":"curling","name":"men's tournament","a":"","b":"","c":"","field":"PICKING #field"},{"id":39,"date":"22/02/2026","sport":"curling","name":"women's tournament","a":"","b":"","c":"","field":"PICKING #field"},{"id":40,"date":"10/02/2026","sport":"curling","name":"mixed doubles","a":"","b":"","c":"","field":"PICKING #field"},{"id":41,"date":"13/02/2026","sport":"figure skating","name":"men single skating","a":"","b":"","c":"","field":"PICKING #field"},{"id":42,"date":"19/02/2026","sport":"figure skating","name":"women single skating","a":"","b":"","c":"","field":"PICKING #field"},{"id":43,"date":"16/02/2026","sport":"figure skating","name":"pair skating","a":"","b":"","c":"","field":"PICKING #field"},{"id":44,"date":"11/02/2026","sport":"figure skating","name":"ice dance","a":"","b":"","c":"","field":"PICKING #field"},{"id":45,"date":"08/02/2026","sport":"figure skating","name":"team event","a":"","b":"","c":"","field":"PICKING #field"},{"id":46,"date":"19/02/2026","sport":"freestyle skiing","name":"men's aerials","a":"","b":"","c":"","field":"PICKING #field"},{"id":47,"date":"12/02/2026","sport":"freestyle skiing","name":"men's moguls","a":"","b":"","c":"","field":"PICKING #field"},{"id":48,"date":"15/02/2026","sport":"freestyle skiing","name":"men's dual moguls","a":"","b":"","c":"","field":"PICKING #field"},{"id":49,"date":"21/02/2026","sport":"freestyle skiing","name":"men's ski cross","a":"","b":"","c":"","field":"PICKING #field"},{"id":50,"date":"20/02/2026","sport":"freestyle skiing","name":"men's freeski halfpipe","a":"","b":"","c":"","field":"PICKING #field"},{"id":51,"date":"10/02/2026","sport":"freestyle skiing","name":"men's freeski slopestyle","a":"","b":"","c":"","field":"PICKING #field"},{"id":52,"date":"17/02/2026","sport":"freestyle skiing","name":"men's big air","a":"","b":"","c":"","field":"PICKING #field"},{"id":53,"date":"18/02/2026","sport":"freestyle skiing","name":"women's aerials","a":"","b":"","c":"","field":"PICKING #field"},{"id":54,"date":"11/02/2026","sport":"freestyle skiing","name":"women's moguls","a":"","b":"","c":"","field":"PICKING #field"},{"id":55,"date":"14/02/2026","sport":"freestyle skiing","name":"women's dual moguls","a":"","b":"","c":"","field":"PICKING #field"},{"id":56,"date":"20/02/2026","sport":"freestyle skiing","name":"women's ski cross","a":"","b":"","c":"","field":"PICKING #field"},{"id":57,"date":"21/02/2026","sport":"freestyle skiing","name":"women's freeski halfpipe","a":"","b":"","c":"","field":"PICKING #field"},{"id":58,"date":"09/02/2026","sport":"freestyle skiing","name":"women's freeski slopestyle","a":"","b":"","c":"","field":"PICKING #field"},{"id":59,"date":"16/02/2026","sport":"freestyle skiing","name":"women's big air","a":"","b":"","c":"","field":"PICKING #field"},{"id":60,"date":"21/02/2026","sport":"freestyle skiing","name":"mixed team aerials","a":"","b":"","c":"","field":"PICKING #field"},{"id":61,"date":"22/02/2026","sport":"ice hockey","name":"men's tournament","a":"CANADA","b":"USA","c":"SVEZIA","field":"PICKING #field"},{"id":62,"date":"19/02/2026","sport":"ice hockey","name":"women's tournament","a":"CANADA","b":"USA","c":"REPUBBLICA CECA","field":"PICKING #field"},{"id":63,"date":"08/02/2026","sport":"luge","name":"men's singles","a":"","b":"","c":"","field":"PICKING #field"},{"id":64,"date":"11/02/2026","sport":"luge","name":"men's doubles","a":"","b":"","c":"","field":"PICKING #field"},{"id":65,"date":"10/02/2026","sport":"luge","name":"women's singles","a":"","b":"","c":"","field":"PICKING #field"},{"id":66,"date":"11/02/2026","sport":"luge","name":"women's doubles","a":"","b":"","c":"","field":"PICKING #field"},{"id":67,"date":"12/02/2026","sport":"luge","name":"team relay","a":"","b":"","c":"","field":"PICKING #field"},{"id":68,"date":"11/02/2026","sport":"nordic combined","name":"individual NH / 10km","a":"","b":"","c":"","field":"PICKING #field"},{"id":69,"date":"17/02/2026","sport":"nordic combined","name":"individual LH / 10km","a":"","b":"","c":"","field":"PICKING #field"},{"id":70,"date":"19/02/2026","sport":"nordic combined","name":"team sprint LH /2x7,5km","a":"","b":"","c":"","field":"PICKING #field"},{"id":71,"date":"18/02/2026","sport":"short track","name":"men's 500m","a":"","b":"","c":"","field":"PICKING #field"},{"id":72,"date":"12/02/2026","sport":"short track","name":"men's 1000m","a":"","b":"","c":"","field":"PICKING #field"},{"id":73,"date":"14/02/2026","sport":"short track","name":"men's 1500m","a":"","b":"","c":"","field":"PICKING #field"},{"id":74,"date":"20/02/2026","sport":"short track","name":"men's 5000m relay","a":"","b":"","c":"","field":"PICKING #field"},{"id":75,"date":"12/02/2026","sport":"short track","name":"women's 500m","a":"","b":"","c":"","field":"PICKING #field"},{"id":76,"date":"16/02/2026","sport":"short track","name":"women's 1000m","a":"","b":"","c":"","field":"PICKING #field"},{"id":77,"date":"20/02/2026","sport":"short track","name":"women's 1500m","a":"","b":"","c":"","field":"PICKING #field"},{"id":78,"date":"18/02/2026","sport":"short track","name":"women's 3000m relay","a":"","b":"","c":"","field":"PICKING #field"},{"id":79,"date":"10/02/2026","sport":"short track","name":"mixed team relay","a":"","b":"","c":"","field":"PICKING #field"},{"id":80,"date":"13/02/2026","sport":"skeleton","name":"men's skeleton","a":"Matt Weston (GBR)","b":"Marcus Wyatt (GBR)","c":"","field":"PICKING #field"},{"id":81,"date":"14/02/2026","sport":"skeleton","name":"women's skeleton","a":"","b":"","c":"","field":"PICKING #field"},{"id":82,"date":"15/02/2026","sport":"skeleton","name":"mixed team","a":"","b":"","c":"","field":"PICKING #field"},{"id":83,"date":"09/02/2026","sport":"ski jumping","name":"men's normal hill","a":"","b":"","c":"","field":"PICKING #field"},{"id":84,"date":"14/02/2026","sport":"ski jumping","name":"men's large hill","a":"","b":"","c":"","field":"PICKING #field"},{"id":85,"date":"16/02/2026","sport":"ski jumping","name":"men's super team","a":"","b":"","c":"","field":"PICKING #field"},{"id":86,"date":"07/02/2026","sport":"ski jumping","name":"women's normal hill","a":"","b":"","c":"","field":"PICKING #field"},{"id":87,"date":"15/02/2026","sport":"ski jumping","name":"women's large hill","a":"","b":"","c":"","field":"PICKING #field"},{"id":88,"date":"10/02/2026","sport":"ski jumping","name":"mixed team","a":"","b":"","c":"","field":"PICKING #field"},{"id":89,"date":"08/02/2026","sport":"snowboard","name":"men's parallel GS","a":"","b":"","c":"","field":"PICKING #field"},{"id":90,"date":"13/02/2026","sport":"snowboard","name":"men's halfpipe","a":"","b":"","c":"","field":"PICKING #field"},{"id":91,"date":"12/02/2026","sport":"snowboard","name":"men's snowboard-cross","a":"","b":"","c":"","field":"PICKING #field"},{"id":92,"date":"18/02/2026","sport":"snowboard","name":"men's slopestyle","a":"","b":"","c":"","field":"PICKING #field"},{"id":93,"date":"07/02/2026","sport":"snowboard","name":"men's big air","a":"","b":"","c":"","field":"PICKING #field"},{"id":94,"date":"08/02/2026","sport":"snowboard","name":"women's parallel GS","a":"","b":"","c":"","field":"PICKING #field"},{"id":95,"date":"12/02/2026","sport":"snowboard","name":"women's halfpipe","a":"","b":"","c":"","field":"PICKING #field"},{"id":96,"date":"13/02/2026","sport":"snowboard","name":"women's snowboard-cross","a":"","b":"","c":"","field":"PICKING #field"},{"id":97,"date":"17/02/2026","sport":"snowboard","name":"women's slopestyle","a":"","b":"","c":"","field":"PICKING #field"},{"id":98,"date":"09/02/2026","sport":"snowboard","name":"women's big air","a":"","b":"","c":"","field":"PICKING #field"},{"id":99,"date":"15/02/2026","sport":"snowboard","name":"mixed team snowboard-cross","a":"","b":"","c":"","field":"PICKING #field"},{"id":100,"date":"14/02/2026","sport":"speed skating","name":"men's 500m","a":"","b":"","c":"","field":"PICKING #field"},{"id":101,"date":"11/02/2026","sport":"speed skating","name":"men's 1000m","a":"Jordan Stolz (USA)","b":"","c":"","field":"PICKING #field"},{"id":102,"date":"19/02/2026","sport":"speed skating","name":"men's 1500m","a":"Jordan Stolz (USA)","b":"","c":"","field":"PICKING #field"},{"id":103,"date":"08/02/2026","sport":"speed skating","name":"men's 5000m","a":"","b":"","c":"","field":"PICKING #field"},{"id":104,"date":"13/02/2026","sport":"speed skating","name":"men's 10000m","a":"","b":"","c":"","field":"PICKING #field"},{"id":105,"date":"17/02/2026","sport":"speed skating","name":"men's team pursuit","a":"USA","b":"FRANCIA","c":"OLANDA","field":"PICKING #field"},{"id":106,"date":"21/02/2026","sport":"speed skating","name":"men's mass start","a":"","b":"","c":"","field":"PICKING #field"},{"id":107,"date":"15/02/2026","sport":"speed skating","name":"women's 500m","a":"Femke Kok (NED)","b":"","c":"","field":"PICKING #field"},{"id":108,"date":"09/02/2026","sport":"speed skating","name":"women's 1000m","a":"","b":"","c":"","field":"PICKING #field"},{"id":109,"date":"20/02/2026","sport":"speed skating","name":"women's 1500m","a":"Joy Beune (NED)","b":"","c":"","field":"PICKING #field"},{"id":110,"date":"07/02/2026","sport":"speed skating","name":"women's 3000m","a":"Joy Beune (NED)","b":"","c":"","field":"PICKING #field"},{"id":111,"date":"12/02/2026","sport":"speed skating","name":"women's 5000m","a":"","b":"","c":"","field":"PICKING #field"},{"id":112,"date":"17/02/2026","sport":"speed skating","name":"women's team pursuit","a":"OLANDA","b":"CANADA","c":"GIAPPONE","field":"PICKING #field"},{"id":113,"date":"21/02/2026","sport":"speed skating","name":"women's mass start","a":"","b":"","c":"","field":"PICKING #field"},{"id":114,"date":"19/02/2026","sport":"ski mountaineering","name":"men's sprint","a":"","b":"","c":"","field":"PICKING #field"},{"id":115,"date":"19/02/2026","sport":"ski mountaineering","name":"women's sprint","a":"","b":"","c":"","field":"PICKING #field"},{"id":116,"date":"21/02/2026","sport":"ski mountaineering","name":"mixed relay","a":"","b":"","c":"","field":"PICKING #field"}]]; 
// ==========================================================

const ADMIN_PASS = "cortina2026";
const POINTS = { a: 15, b: 18, c: 25, field: 10 };

// Inizializzazione DB forzata
let storedData = JSON.parse(localStorage.getItem('mc2026_final_db')) || { participants: {}, results: {} };
let db = {
    events: DATI_FISSI.length > 0 ? DATI_FISSI : (JSON.parse(localStorage.getItem('mc2026_temp_events')) || []),
    participants: storedData.participants || {},
    results: storedData.results || {}
};

function save() {
    localStorage.setItem('mc2026_final_db', JSON.stringify({ participants: db.participants, results: db.results }));
    if (db.events.length > 0 && DATI_FISSI.length === 0) {
        localStorage.setItem('mc2026_temp_events', JSON.stringify(db.events));
    }
    render();
}

function startGame() {
    const name = document.getElementById('user-name').value.trim();
    if(!name) return alert("Inserisci un nickname!");
    if(db.events.length === 0) return alert("Errore: Nessun evento caricato. L'admin deve configurare il file correttamente.");
    
    document.getElementById('user-welcome').classList.add('hidden');
    document.getElementById('user-game').classList.remove('hidden');
    document.getElementById('display-name').innerText = name;
    render();
}

// FIX EXCEL DATA E COLONNE
function excelDateToJS(serial) {
    if(!serial) return "";
    if(isNaN(serial)) return serial.toString();
    const date = new Date(Math.round((serial - 25569) * 86400 * 1000));
    return date.toLocaleDateString('it-IT');
}

document.getElementById('xl-in').addEventListener('change', (e) => {
    const reader = new FileReader();
    reader.onload = (evt) => {
        const workbook = XLSX.read(evt.target.result, { type: 'binary' });
        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        
        const find = (r, keys) => {
            const match = Object.keys(r).find(k => keys.some(t => k.trim().toLowerCase().includes(t.toLowerCase())));
            return r[match] || '';
        };

        db.events = rows.map((r, i) => ({
            id: i + 1,
            date: excelDateToJS(find(r, ['data-sport-event', 'data', 'giorno', 'date'])),
            sport: find(r, ['sport', 'disciplina']),
            name: find(r, ['evento', 'event', 'gara']),
            a: find(r, ['picking #a', 'pick a', 'scelta a']),
            b: find(r, ['picking #b', 'pick b', 'scelta b']),
            c: find(r, ['picking #c', 'pick c', 'scelta c']),
            field: find(r, ['field', 'altro', 'picking field'])
        }));
        save();
        alert("Excel caricato! Ora clicca su 'Genera Dati per GitHub' e segui le istruzioni.");
    };
    reader.readAsBinaryString(e.target.files[0]);
});

function exportDataForGitHub() {
    if(db.events.length === 0) return alert("Carica prima l'Excel!");
    const str = JSON.stringify(db.events);
    navigator.clipboard.writeText(str);
    alert("Dati Copiati! Ora:\n1. Apri index.html sul PC con il Blocco Note.\n2. Incolla tra le parentesi di DATI_FISSI.\n3. Salva e ricarica su GitHub.");
}

function switchTab(t) {
    document.getElementById('section-user').classList.toggle('hidden', t !== 'user');
    document.getElementById('section-admin').classList.toggle('hidden', t !== 'admin');
}

function unlockAdmin() {
    if(document.getElementById('admin-pass').value === ADMIN_PASS) {
        document.getElementById('admin-login').classList.add('hidden');
        document.getElementById('admin-content').classList.remove('hidden');
    } else alert("Password Errata");
}

function makePick(id, o) {
    const n = document.getElementById('user-name').value.trim();
    if(!db.participants[n]) db.participants[n] = { picks: {}, auto: false };
    db.participants[n].picks[id] = o;
    save();
}

function importUser() {
    try {
        const d = JSON.parse(decodeURIComponent(atob(document.getElementById('in-code').value.trim())));
        db.participants[d.n] = { picks: d.p, auto: d.a };
        document.getElementById('in-code').value = '';
        save();
        alert("Importato: " + d.n);
    } catch(e) { alert("Codice non valido!"); }
}

function delUser(n) { if(confirm("Eliminare "+n+"?")) { delete db.participants[n]; save(); } }
function setWinner(id, o) { db.results[id] = (db.results[id] === o) ? null : o; save(); }

function render() {
    const curName = document.getElementById('user-name').value.trim();
    const userPicks = db.participants[curName]?.picks || {};

    // GRID UTENTE
    document.getElementById('events-grid').innerHTML = db.events.map(ev => `
        <div class="card-ev bg-white p-6 shadow-sm border border-slate-100">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">${ev.sport}</span>
                <span class="text-[10px] text-red-600 font-black italic">${ev.date || '---'}</span>
            </div>
            <h4 class="font-bold text-slate-800 text-sm mb-4 leading-tight h-10 overflow-hidden">${ev.name}</h4>
            <div class="grid grid-cols-1 gap-2">
                ${['a','b','c','field'].map(o => {
                    const active = userPicks[ev.id] === o;
                    const cl = active ? 'active-'+o : 'bg-slate-50 text-slate-500 border-transparent';
                    return `<button onclick="makePick(${ev.id}, '${o}')" class="btn-pick p-3 rounded-xl text-[10px] flex justify-between items-center border-2 transition-all ${cl} hover:border-slate-300">
                        <span class="truncate pr-2">${ev[o]}</span> <span class="text-[8px] opacity-60 font-black">${POINTS[o]}PT</span>
                    </button>`;
                }).join('')}
            </div>
        </div>
    `).join('');

    // LISTA ADMIN (DETTAGLIO SCELTE)
    document.getElementById('admin-events-list').innerHTML = db.events.map(ev => {
        const votes = {a:[], b:[], c:[], field:[]};
        Object.keys(db.participants).forEach(n => {
            const pk = db.participants[n].picks[ev.id];
            if(pk) votes[pk].push({n, a:db.participants[n].auto});
        });
        return `
        <div class="bg-slate-50 rounded-2xl border border-slate-200 overflow-hidden">
            <div class="p-4 bg-white flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex-1 text-xs font-bold text-slate-700">${ev.name} <br><span class="text-[9px] text-slate-300 font-normal uppercase">${ev.date}</span></div>
                <div class="flex gap-1 bg-slate-100 p-1 rounded-xl">
                    ${['a','b','c','field'].map(o => `<button onclick="setWinner(${ev.id}, '${o}')" class="w-10 h-7 rounded-lg font-black text-[9px] transition-all ${db.results[ev.id]===o?'bg-red-600 text-white shadow-md':'text-slate-400'}">${o.toUpperCase()}</button>`).join('')}
                </div>
            </div>
            <div class="p-3 grid grid-cols-2 md:grid-cols-4 gap-4 text-[8px] border-t border-slate-100 bg-slate-50/50">
                ${['a','b','c','field'].map(o => `
                    <div>
                        <b class="text-slate-400 uppercase block mb-1">${o}: ${ev[o]}</b>
                        <div class="flex flex-wrap gap-1">
                            ${votes[o].map(p=>`<span class="bg-white border px-2 py-0.5 rounded shadow-sm ${p.a?'text-amber-500 font-bold':''}">${p.n}</span>`).join('') || '-'}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>`;
    }).join('');

    // RANKING
    const rnk = Object.keys(db.participants).map(n => {
        let s = 0;
        Object.keys(db.participants[n].picks).forEach(id => { if(db.results[id]===db.participants[n].picks[id]) s += POINTS[db.participants[n].picks[id]]; });
        return { n, s, a: db.participants[n].auto };
    }).sort((a,b) => b.s - a.s);

    document.getElementById('ranking-list').innerHTML = rnk.map((p,i) => `
        <div class="flex justify-between items-center p-3 bg-white rounded-2xl border border-slate-100 shadow-sm">
            <div class="flex items-center gap-3">
                <span class="font-black ${i<3?'text-red-600':'text-slate-300'} text-lg">#${i+1}</span>
                <div>
                    <div class="font-bold text-[11px] text-slate-800">${p.n} ${p.a?'ü§ñ':''}</div>
                    <button onclick="delUser('${p.n.replace(/'/g, "\\'")}')" class="text-[8px] text-red-400 font-black uppercase hover:underline">Elimina</button>
                </div>
            </div>
            <div class="text-lg font-black text-green-600">${p.s}</div>
        </div>
    `).join('');
}

// ALTRE FUNZIONI
function autoFillContest() {
    const n = document.getElementById('user-name').value.trim();
    if(!n) return alert("Nickname!");
    db.events.forEach(ev => {
        if(!db.participants[n]) db.participants[n] = { picks: {} };
        db.participants[n].picks[ev.id] = ['a','b','c','field'][Math.floor(Math.random()*4)];
    });
    db.participants[n].auto = true;
    save();
}

function generateCode() {
    const n = document.getElementById('user-name').value.trim();
    if(!n || !db.participants[n]) return alert("Fai le tue scelte!");
    const c = btoa(encodeURIComponent(JSON.stringify({ n, p: db.participants[n].picks, a: db.participants[n].auto })));
    navigator.clipboard.writeText(c);
    alert("Codice Copiato! Mandala all'Admin su WhatsApp ‚ú®");
}

function shareWhatsApp() {
    const rnk = Object.keys(db.participants).map(n => {
        let s = 0;
        Object.keys(db.participants[n].picks).forEach(id => { if(db.results[id]===db.participants[n].picks[id]) s += POINTS[db.participants[n].picks[id]]; });
        return { n, s, a: db.participants[n].auto };
    }).sort((a,b) => b.s - a.s);
    let t = "*RANKING MILANO CORTINA 2026* ü•á\n\n";
    rnk.forEach((p,i) => t += `${i+1}. *${p.n}*: ${p.s} pt ${p.a?'ü§ñ':''}\n`);
    navigator.clipboard.writeText(t).then(() => alert("Classifica copiata!"));
}

function resetAllData() {
    if(confirm("ATTENZIONE: Questo canceller√† tutti i partecipanti e i risultati inseriti finora. Procedere?")) {
        localStorage.clear();
        location.reload();
    }
}

function downloadPDF() {
    const n = document.getElementById('user-name').value.trim();
    if(!n) return;
    const el = document.createElement('div');
    el.className = "p-10 font-sans";
    el.innerHTML = `<h1 style="color:#CD212A; border-bottom:4px solid #008C45; padding-bottom:10px; font-size:30px; font-weight:900">MILANO CORTINA 2026</h1><p style="font-size:18px">Atleta: <b>${n}</b></p><br><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:10px">${db.events.map(ev => { const p = db.participants[n]?.picks[ev.id]; return p ? `<div style="padding:8px; border:1px solid #eee; border-radius:10px; background:#f9f9f9"><b>${ev.name}</b><br><span style="color:#008C45">Scelta: ${ev[p]}</span></div>` : ''; }).join('')}</div>`;
    html2pdf().from(el).set({ margin: 10, filename: `MC2026_${n}.pdf`, html2canvas: { scale: 2 } }).save();
}

// Render iniziale se ci sono dati fissi
if(DATI_FISSI.length > 0) render();
</script>
</body>
</html>