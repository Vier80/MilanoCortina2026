<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milano Cortina 2026 | Contest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f1f5f9; }
        .ita-gradient { background: linear-gradient(90deg, #008C45 0%, #ffffff 50%, #CD212A 100%); }
        .active-a { background-color: #008C45 !important; color: white !important; }
        .active-b { background-color: #CD212A !important; color: white !important; }
        .active-c { background-color: #004D99 !important; color: white !important; }
        .active-field { background-color: #FFD700 !important; color: #000 !important; }
        .card-ev { border-radius: 1.5rem; border-top: 6px solid #1e293b; transition: transform 0.3s; }
        .hidden { display: none; }
    </style>
</head>
<body class="antialiased text-slate-900">

<div class="ita-gradient h-2 w-full fixed top-0 z-[100]"></div>

<nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200 shadow-sm h-20 flex items-center">
    <div class="max-w-7xl mx-auto px-4 w-full flex justify-between items-center">
        <h1 class="font-black text-xl tracking-tighter">MILANO CORTINA <span class="text-red-600">2026</span></h1>
        <button onclick="switchTab('admin')" class="px-5 py-2 rounded-xl font-bold text-xs text-slate-400 uppercase hover:text-red-600">Admin</button>
    </div>
</nav>

<div class="max-w-7xl mx-auto p-4 md:p-8">

    <div id="section-user">
        <div id="user-welcome" class="max-w-xl mx-auto mt-12 p-10 bg-white rounded-[2.5rem] shadow-2xl text-center space-y-8 border-b-8 border-green-600">
            <h2 class="text-4xl font-black uppercase italic">Sfida Olimpica ðŸ‡®ðŸ‡¹</h2>
            <input type="text" id="user-name" placeholder="Tuo Nickname (Emoji âœ¨)" 
                   class="w-full bg-slate-50 border-4 border-slate-100 p-5 rounded-2xl focus:border-green-600 outline-none font-black text-2xl text-center">
            <button onclick="startGame()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xl shadow-xl uppercase hover:bg-black transition">Gioca</button>
        </div>

        <div id="user-game" class="hidden space-y-8">
            <div class="bg-white p-6 rounded-3xl shadow-lg border-l-8 border-red-600 flex flex-col md:flex-row justify-between items-center gap-4">
                <h3 id="display-name" class="text-2xl font-black italic"></h3>
                <div class="flex flex-wrap gap-2">
                    <button onclick="autoFillContest()" class="px-4 py-2 bg-slate-100 rounded-lg font-bold text-[10px] uppercase">ðŸ¤– Casuale</button>
                    <button onclick="downloadPDF()" class="px-4 py-2 bg-slate-900 text-white rounded-lg font-bold text-[10px] uppercase">PDF</button>
                    <button onclick="generateCode()" class="px-6 py-2 bg-red-600 text-white rounded-lg font-black text-[10px] uppercase">Copia Codice Admin</button>
                </div>
            </div>
            <div id="events-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <div id="section-admin" class="hidden">
        <div id="admin-login" class="max-w-md mx-auto mt-20 p-8 bg-white rounded-3xl shadow-xl text-center space-y-4">
            <h2 class="font-black italic text-xl">Password Admin</h2>
            <input type="password" id="admin-pass" class="w-full p-4 border rounded-xl text-center font-bold">
            <button onclick="unlockAdmin()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold">Entra</button>
        </div>

        <div id="admin-content" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-md">
                    <h3 class="font-black uppercase italic mb-4">Ranking</h3>
                    <div id="ranking-list" class="space-y-2"></div>
                </div>
                <div class="bg-slate-900 text-white p-6 rounded-3xl space-y-4">
                    <p class="text-[10px] text-slate-400">1. Carica l'Excel per generare i dati</p>
                    <button onclick="document.getElementById('xl-in').click()" class="w-full py-3 bg-slate-800 rounded-xl font-bold text-xs uppercase">Carica Excel</button>
                    <input type="file" id="xl-in" class="hidden" accept=".xlsx, .xls">
                    
                    <button onclick="exportDataForGitHub()" class="w-full py-3 bg-blue-600 rounded-xl font-bold text-xs uppercase">Genera Dati per GitHub</button>
                    
                    <textarea id="in-code" placeholder="Incolla codice partecipante..." class="w-full h-24 bg-slate-800 rounded-xl p-3 text-[10px] font-mono"></textarea>
                    <button onclick="importUser()" class="w-full py-3 bg-green-600 rounded-xl font-bold text-xs uppercase">Importa Partecipante</button>
                </div>
            </div>
            <div class="lg:col-span-8 bg-white p-6 rounded-3xl shadow-md">
                <div id="admin-events-list" class="space-y-6 max-h-[800px] overflow-y-auto"></div>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================================
// SEZIONE DATI_PRECARICATI
// Incolla qui l'output del tasto "Genera Dati per GitHub"
// ==========================================================
const DATI_FISSI = [[{"id":1,"date":46060,"sport":"alpine skiing","name":"men's downhill","a":"","b":"","c":"","field":"PICKING #field"},{"id":2,"date":46064,"sport":"alpine skiing","name":"men's super-G","a":"Marco Odermatt (SUI)","b":"Vincent Kriechmayr","c":"Franjo Von Allmen","field":"PICKING #field"},{"id":3,"date":46067,"sport":"alpine skiing","name":"men's giant slalom","a":"Marco Odermatt (SUI)","b":"Alex Steen Olsen","c":"Loic Meillard","field":"PICKING #field"},{"id":4,"date":46069,"sport":"alpine skiing","name":"men's slalom","a":"Clement Noel (FRA)","b":"Lucas Pinheiro Braathen (BRA)","c":"Atle Lie McGrath","field":"PICKING #field"},{"id":5,"date":46062,"sport":"alpine skiing","name":"men's team combined","a":"","b":"","c":"","field":"PICKING #field"},{"id":6,"date":46061,"sport":"alpine skiing","name":"women's downhill","a":"Sofia Goggia (ITA)","b":"Lindsey Vonn (USA)","c":"Cornelia Huetter","field":"PICKING #field"},{"id":7,"date":46065,"sport":"alpine skiing","name":"women's super-G","a":"","b":"","c":"","field":"PICKING #field"},{"id":8,"date":46068,"sport":"alpine skiing","name":"women's giant slalom","a":"","b":"","c":"","field":"PICKING #field"},{"id":9,"date":46071,"sport":"alpine skiing","name":"women's slalom","a":"Mikaela Shiffrin (USA)","b":"Camille Rast","c":"Zrinka Ljutic","field":"PICKING #field"},{"id":10,"date":46063,"sport":"alpine skiing","name":"women's team combined","a":"","b":"","c":"","field":"PICKING #field"},{"id":11,"date":46066,"sport":"biathlon","name":"men's 10km sprint","a":"","b":"","c":"","field":"PICKING #field"},{"id":12,"date":46063,"sport":"biathlon","name":"men's 20km individual","a":"","b":"","c":"","field":"PICKING #field"},{"id":13,"date":46068,"sport":"biathlon","name":"men's 12,5km pursuit","a":"","b":"","c":"","field":"PICKING #field"},{"id":14,"date":46073,"sport":"biathlon","name":"men's 15km mass start","a":"","b":"","c":"","field":"PICKING #field"},{"id":15,"date":46070,"sport":"biathlon","name":"men's 4x7,5km relay","a":"NORVEGIA","b":"FRANCIA","c":"SVEZIA","field":"PICKING #field"},{"id":16,"date":46067,"sport":"biathlon","name":"women's 7,5km sprint","a":"","b":"","c":"","field":"PICKING #field"},{"id":17,"date":46064,"sport":"biathlon","name":"women's 15km individual","a":"","b":"","c":"","field":"PICKING #field"},{"id":18,"date":46068,"sport":"biathlon","name":"women's 10km pursuit","a":"","b":"","c":"","field":"PICKING #field"},{"id":19,"date":46074,"sport":"biathlon","name":"women's 12,5km mass start","a":"","b":"","c":"","field":"PICKING #field"},{"id":20,"date":46071,"sport":"biathlon","name":"women's 4x6km relay","a":"FRANCIA","b":"SVEZIA","c":"NORVEGIA","field":"PICKING #field"},{"id":21,"date":46061,"sport":"biathlon","name":"mixed relay 4x6km (W+M)","a":"","b":"","c":"","field":"PICKING #field"},{"id":22,"date":46070,"sport":"bobsleigh","name":"2-man","a":"Francesco Friedrich (GER)","b":"Johannes Lochner (GER)","c":"Adam Ammour (GER)","field":"PICKING #field"},{"id":23,"date":46075,"sport":"bobsleigh","name":"4-man","a":"Johannes Lochner (GER)","b":"Francesco Friedrich (GER)","c":"","field":"PICKING #field"},{"id":24,"date":46069,"sport":"bobsleigh","name":"women's monobob","a":"Laura Nolte (GER)","b":"Kaysha Love (USA)","c":"Lisa Buckwitz (GER)","field":"PICKING #field"},{"id":25,"date":46074,"sport":"bobsleigh","name":"2-women","a":"Laura Nolte (GER)","b":"Kim Kalicki (GER)","c":"Lisa Buckwitz (GER)","field":"PICKING #field"},{"id":26,"date":46061,"sport":"cross-country","name":"men's skiathlon","a":"","b":"","c":"","field":"PICKING #field"},{"id":27,"date":46063,"sport":"cross-country","name":"men's sprint classic","a":"","b":"","c":"","field":"PICKING #field"},{"id":28,"date":46071,"sport":"cross-country","name":"men's team sprint free","a":"","b":"","c":"","field":"PICKING #field"},{"id":29,"date":46068,"sport":"cross-country","name":"men's 4x7,5km relay","a":"","b":"","c":"","field":"PICKING #field"},{"id":30,"date":46066,"sport":"cross-country","name":"men's 10km free","a":"","b":"","c":"","field":"PICKING #field"},{"id":31,"date":46074,"sport":"cross-country","name":"men's 50km mass start","a":"","b":"","c":"","field":"PICKING #field"},{"id":32,"date":46060,"sport":"cross-country","name":"women's skiathlon","a":"","b":"","c":"","field":"PICKING #field"},{"id":33,"date":46063,"sport":"cross-country","name":"women's sprint classic","a":"","b":"","c":"","field":"PICKING #field"},{"id":34,"date":46071,"sport":"cross-country","name":"women's team sprint free","a":"","b":"","c":"","field":"PICKING #field"},{"id":35,"date":46067,"sport":"cross-country","name":"women's 4x7,5km relay","a":"","b":"","c":"","field":"PICKING #field"},{"id":36,"date":46065,"sport":"cross-country","name":"women's 10km free","a":"","b":"","c":"","field":"PICKING #field"},{"id":37,"date":46074,"sport":"cross-country","name":"women's 50km mass start","a":"","b":"","c":"","field":"PICKING #field"},{"id":38,"date":46074,"sport":"curling","name":"men's tournament","a":"","b":"","c":"","field":"PICKING #field"},{"id":39,"date":46075,"sport":"curling","name":"women's tournament","a":"","b":"","c":"","field":"PICKING #field"},{"id":40,"date":46063,"sport":"curling","name":"mixed doubles","a":"","b":"","c":"","field":"PICKING #field"},{"id":41,"date":46066,"sport":"figure skating","name":"men single skating","a":"","b":"","c":"","field":"PICKING #field"},{"id":42,"date":46072,"sport":"figure skating","name":"women single skating","a":"","b":"","c":"","field":"PICKING #field"},{"id":43,"date":46069,"sport":"figure skating","name":"pair skating","a":"","b":"","c":"","field":"PICKING #field"},{"id":44,"date":46064,"sport":"figure skating","name":"ice dance","a":"","b":"","c":"","field":"PICKING #field"},{"id":45,"date":46061,"sport":"figure skating","name":"team event","a":"","b":"","c":"","field":"PICKING #field"},{"id":46,"date":46072,"sport":"freestyle skiing","name":"men's aerials","a":"","b":"","c":"","field":"PICKING #field"},{"id":47,"date":46065,"sport":"freestyle skiing","name":"men's moguls","a":"","b":"","c":"","field":"PICKING #field"},{"id":48,"date":46068,"sport":"freestyle skiing","name":"men's dual moguls","a":"","b":"","c":"","field":"PICKING #field"},{"id":49,"date":46074,"sport":"freestyle skiing","name":"men's ski cross","a":"","b":"","c":"","field":"PICKING #field"},{"id":50,"date":46073,"sport":"freestyle skiing","name":"men's freeski halfpipe","a":"","b":"","c":"","field":"PICKING #field"},{"id":51,"date":46063,"sport":"freestyle skiing","name":"men's freeski slopestyle","a":"","b":"","c":"","field":"PICKING #field"},{"id":52,"date":46070,"sport":"freestyle skiing","name":"men's big air","a":"","b":"","c":"","field":"PICKING #field"},{"id":53,"date":46071,"sport":"freestyle skiing","name":"women's aerials","a":"","b":"","c":"","field":"PICKING #field"},{"id":54,"date":46064,"sport":"freestyle skiing","name":"women's moguls","a":"","b":"","c":"","field":"PICKING #field"},{"id":55,"date":46067,"sport":"freestyle skiing","name":"women's dual moguls","a":"","b":"","c":"","field":"PICKING #field"},{"id":56,"date":46073,"sport":"freestyle skiing","name":"women's ski cross","a":"","b":"","c":"","field":"PICKING #field"},{"id":57,"date":46074,"sport":"freestyle skiing","name":"women's freeski halfpipe","a":"","b":"","c":"","field":"PICKING #field"},{"id":58,"date":46062,"sport":"freestyle skiing","name":"women's freeski slopestyle","a":"","b":"","c":"","field":"PICKING #field"},{"id":59,"date":46069,"sport":"freestyle skiing","name":"women's big air","a":"","b":"","c":"","field":"PICKING #field"},{"id":60,"date":46074,"sport":"freestyle skiing","name":"mixed team aerials","a":"","b":"","c":"","field":"PICKING #field"},{"id":61,"date":46075,"sport":"ice hockey","name":"men's tournament","a":"CANADA","b":"USA","c":"SVEZIA","field":"PICKING #field"},{"id":62,"date":46072,"sport":"ice hockey","name":"women's tournament","a":"CANADA","b":"USA","c":"REPUBBLICA CECA","field":"PICKING #field"},{"id":63,"date":46061,"sport":"luge","name":"men's singles","a":"","b":"","c":"","field":"PICKING #field"},{"id":64,"date":46064,"sport":"luge","name":"men's doubles","a":"","b":"","c":"","field":"PICKING #field"},{"id":65,"date":46063,"sport":"luge","name":"women's singles","a":"","b":"","c":"","field":"PICKING #field"},{"id":66,"date":46064,"sport":"luge","name":"women's doubles","a":"","b":"","c":"","field":"PICKING #field"},{"id":67,"date":46065,"sport":"luge","name":"team relay","a":"","b":"","c":"","field":"PICKING #field"},{"id":68,"date":46064,"sport":"nordic combined","name":"individual NH / 10km","a":"","b":"","c":"","field":"PICKING #field"},{"id":69,"date":46070,"sport":"nordic combined","name":"individual LH / 10km","a":"","b":"","c":"","field":"PICKING #field"},{"id":70,"date":46072,"sport":"nordic combined","name":"team sprint LH /2x7,5km","a":"","b":"","c":"","field":"PICKING #field"},{"id":71,"date":46071,"sport":"short track","name":"men's 500m","a":"","b":"","c":"","field":"PICKING #field"},{"id":72,"date":46065,"sport":"short track","name":"men's 1000m","a":"","b":"","c":"","field":"PICKING #field"},{"id":73,"date":46067,"sport":"short track","name":"men's 1500m","a":"","b":"","c":"","field":"PICKING #field"},{"id":74,"date":46073,"sport":"short track","name":"men's 5000m relay","a":"","b":"","c":"","field":"PICKING #field"},{"id":75,"date":46065,"sport":"short track","name":"women's 500m","a":"","b":"","c":"","field":"PICKING #field"},{"id":76,"date":46069,"sport":"short track","name":"women's 1000m","a":"","b":"","c":"","field":"PICKING #field"},{"id":77,"date":46073,"sport":"short track","name":"women's 1500m","a":"","b":"","c":"","field":"PICKING #field"},{"id":78,"date":46071,"sport":"short track","name":"women's 3000m relay","a":"","b":"","c":"","field":"PICKING #field"},{"id":79,"date":46063,"sport":"short track","name":"mixed team relay","a":"","b":"","c":"","field":"PICKING #field"},{"id":80,"date":46066,"sport":"skeleton","name":"men's skeleton","a":"Matt Weston (GBR)","b":"Marcus Wyatt (GBR)","c":"","field":"PICKING #field"},{"id":81,"date":46067,"sport":"skeleton","name":"women's skeleton","a":"","b":"","c":"","field":"PICKING #field"},{"id":82,"date":46068,"sport":"skeleton","name":"mixed team","a":"","b":"","c":"","field":"PICKING #field"},{"id":83,"date":46062,"sport":"ski jumping","name":"men's normal hill","a":"","b":"","c":"","field":"PICKING #field"},{"id":84,"date":46067,"sport":"ski jumping","name":"men's large hill","a":"","b":"","c":"","field":"PICKING #field"},{"id":85,"date":46069,"sport":"ski jumping","name":"men's super team","a":"","b":"","c":"","field":"PICKING #field"},{"id":86,"date":46060,"sport":"ski jumping","name":"women's normal hill","a":"","b":"","c":"","field":"PICKING #field"},{"id":87,"date":46068,"sport":"ski jumping","name":"women's large hill","a":"","b":"","c":"","field":"PICKING #field"},{"id":88,"date":46063,"sport":"ski jumping","name":"mixed team","a":"","b":"","c":"","field":"PICKING #field"},{"id":89,"date":46061,"sport":"snowboard","name":"men's parallel GS","a":"","b":"","c":"","field":"PICKING #field"},{"id":90,"date":46066,"sport":"snowboard","name":"men's halfpipe","a":"","b":"","c":"","field":"PICKING #field"},{"id":91,"date":46065,"sport":"snowboard","name":"men's snowboard-cross","a":"","b":"","c":"","field":"PICKING #field"},{"id":92,"date":46071,"sport":"snowboard","name":"men's slopestyle","a":"","b":"","c":"","field":"PICKING #field"},{"id":93,"date":46060,"sport":"snowboard","name":"men's big air","a":"","b":"","c":"","field":"PICKING #field"},{"id":94,"date":46061,"sport":"snowboard","name":"women's parallel GS","a":"","b":"","c":"","field":"PICKING #field"},{"id":95,"date":46065,"sport":"snowboard","name":"women's halfpipe","a":"","b":"","c":"","field":"PICKING #field"},{"id":96,"date":46066,"sport":"snowboard","name":"women's snowboard-cross","a":"","b":"","c":"","field":"PICKING #field"},{"id":97,"date":46070,"sport":"snowboard","name":"women's slopestyle","a":"","b":"","c":"","field":"PICKING #field"},{"id":98,"date":46062,"sport":"snowboard","name":"women's big air","a":"","b":"","c":"","field":"PICKING #field"},{"id":99,"date":46068,"sport":"snowboard","name":"mixed team snowboard-cross","a":"","b":"","c":"","field":"PICKING #field"},{"id":100,"date":46067,"sport":"speed skating","name":"men's 500m","a":"","b":"","c":"","field":"PICKING #field"},{"id":101,"date":46064,"sport":"speed skating","name":"men's 1000m","a":"Jordan Stolz (USA)","b":"","c":"","field":"PICKING #field"},{"id":102,"date":46072,"sport":"speed skating","name":"men's 1500m","a":"Jordan Stolz (USA)","b":"","c":"","field":"PICKING #field"},{"id":103,"date":46061,"sport":"speed skating","name":"men's 5000m","a":"","b":"","c":"","field":"PICKING #field"},{"id":104,"date":46066,"sport":"speed skating","name":"men's 10000m","a":"","b":"","c":"","field":"PICKING #field"},{"id":105,"date":46070,"sport":"speed skating","name":"men's team pursuit","a":"USA","b":"FRANCIA","c":"OLANDA","field":"PICKING #field"},{"id":106,"date":46074,"sport":"speed skating","name":"men's mass start","a":"","b":"","c":"","field":"PICKING #field"},{"id":107,"date":46068,"sport":"speed skating","name":"women's 500m","a":"Femke Kok (NED)","b":"","c":"","field":"PICKING #field"},{"id":108,"date":46062,"sport":"speed skating","name":"women's 1000m","a":"","b":"","c":"","field":"PICKING #field"},{"id":109,"date":46073,"sport":"speed skating","name":"women's 1500m","a":"Joy Beune (NED)","b":"","c":"","field":"PICKING #field"},{"id":110,"date":46060,"sport":"speed skating","name":"women's 3000m","a":"Joy Beune (NED)","b":"","c":"","field":"PICKING #field"},{"id":111,"date":46065,"sport":"speed skating","name":"women's 5000m","a":"","b":"","c":"","field":"PICKING #field"},{"id":112,"date":46070,"sport":"speed skating","name":"women's team pursuit","a":"OLANDA","b":"CANADA","c":"GIAPPONE","field":"PICKING #field"},{"id":113,"date":46074,"sport":"speed skating","name":"women's mass start","a":"","b":"","c":"","field":"PICKING #field"},{"id":114,"date":46072,"sport":"ski mountaineering","name":"men's sprint","a":"","b":"","c":"","field":"PICKING #field"},{"id":115,"date":46072,"sport":"ski mountaineering","name":"women's sprint","a":"","b":"","c":"","field":"PICKING #field"},{"id":116,"date":46074,"sport":"ski mountaineering","name":"mixed relay","a":"","b":"","c":"","field":"PICKING #field"}]]; 
// ==========================================================

const ADMIN_PASS = "cortina2026";
const POINTS = { a: 15, b: 18, c: 25, field: 10 };
let db = JSON.parse(localStorage.getItem('olympic_v5')) || { events: DATI_FISSI, participants: {}, results: {} };

// Se i dati fissi sono popolati, sovrascrivi
if(DATI_FISSI.length > 0) db.events = DATI_FISSI;

function save() { localStorage.setItem('olympic_v5', JSON.stringify(db)); render(); }

// FUNZIONE SPECIALE PER TE
function exportDataForGitHub() {
    if(db.events.length === 0) return alert("Carica prima l'Excel!");
    const dataString = JSON.stringify(db.events);
    console.log("Copia questo:", dataString);
    navigator.clipboard.writeText(dataString);
    alert("Dati Copiati! Ora apri il file index.html sul PC, cerca 'const DATI_FISSI = [];' e incolla i dati tra le parentesi quadre.");
}

function startGame() {
    const name = document.getElementById('user-name').value.trim();
    if(!name || db.events.length === 0) return alert("Inserisci il nickname. Se non vedi eventi, l'admin deve ancora configurare il file.");
    document.getElementById('user-welcome').classList.add('hidden');
    document.getElementById('user-game').classList.remove('hidden');
    document.getElementById('display-name').innerText = name;
    render();
}

// LOGICA EXCEL E RENDERING (Stessa di prima, migliorata)
document.getElementById('xl-in').addEventListener('change', (e) => {
    const reader = new FileReader();
    reader.onload = (evt) => {
        const rows = XLSX.utils.sheet_to_json(XLSX.read(evt.target.result, {type:'binary'}).Sheets[XLSX.read(evt.target.result, {type:'binary'}).SheetNames[0]]);
        const find = (r, keys) => {
            const match = Object.keys(r).find(k => keys.some(t => k.trim().toLowerCase().includes(t.toLowerCase())));
            return r[match] || '';
        };
        db.events = rows.map((r, i) => ({
            id: i + 1,
            date: r['Data'] || r['data-sport-event'] || '',
            sport: find(r, ['sport']),
            name: find(r, ['evento', 'event']),
            a: find(r, ['picking #a', 'pick a']),
            b: find(r, ['picking #b', 'pick b']),
            c: find(r, ['picking #c', 'pick c']),
            field: find(r, ['field', 'altro'])
        }));
        save();
        alert("Eventi caricati in memoria locale!");
    };
    reader.readAsBinaryString(e.target.files[0]);
});

function switchTab(t) {
    document.getElementById('section-user').classList.toggle('hidden', t !== 'user');
    document.getElementById('section-admin').classList.toggle('hidden', t !== 'admin');
}

function unlockAdmin() {
    if(document.getElementById('admin-pass').value === ADMIN_PASS) {
        document.getElementById('admin-login').classList.add('hidden');
        document.getElementById('admin-content').classList.remove('hidden');
    } else alert("Errore");
}

function render() {
    const curName = document.getElementById('user-name').value.trim();
    const userPicks = db.participants[curName]?.picks || {};

    // Grid Utente
    document.getElementById('events-grid').innerHTML = db.events.map(ev => `
        <div class="card-ev bg-white p-6 shadow-sm border border-slate-100">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[9px] font-black text-slate-400 uppercase">${ev.sport}</span>
                <span class="text-[10px] text-red-600 font-black italic">${ev.date}</span>
            </div>
            <h4 class="font-bold text-slate-800 text-sm mb-4 leading-tight h-10 overflow-hidden">${ev.name}</h4>
            <div class="grid grid-cols-1 gap-2">
                ${['a','b','c','field'].map(o => {
                    const active = userPicks[ev.id] === o;
                    return `<button onclick="makePick(${ev.id}, '${o}')" class="p-3 rounded-xl text-[10px] font-bold flex justify-between ${active ? 'active-'+o : 'bg-slate-50 text-slate-500'} border-2 border-transparent">
                        <span class="truncate">${ev[o]}</span> <span>${POINTS[o]}PT</span>
                    </button>`;
                }).join('')}
            </div>
        </div>
    `).join('');

    // Admin
    document.getElementById('admin-events-list').innerHTML = db.events.map(ev => `
        <div class="p-4 bg-slate-50 rounded-xl mb-2 flex justify-between items-center">
            <div class="text-xs font-bold">${ev.name}</div>
            <div class="flex gap-1">
                ${['a','b','c','field'].map(o => `<button onclick="setWinner(${ev.id}, '${o}')" class="w-8 h-8 rounded text-[9px] font-black ${db.results[ev.id]===o?'bg-red-600 text-white':'bg-white'}">${o.toUpperCase()}</button>`).join('')}
            </div>
        </div>
    `).join('');

    // Ranking
    const rnk = Object.keys(db.participants).map(n => {
        let s = 0;
        Object.keys(db.participants[n].picks).forEach(id => { if(db.results[id]===db.participants[n].picks[id]) s += POINTS[db.participants[n].picks[id]]; });
        return { n, s };
    }).sort((a,b) => b.s - a.s);
    document.getElementById('ranking-list').innerHTML = rnk.map((p,i) => `<div class="flex justify-between p-2 bg-slate-50 rounded-lg text-xs font-bold"><span>#${i+1} ${p.n}</span><span class="text-green-600">${p.s}</span></div>`).join('');
}

function makePick(id, o) {
    const n = document.getElementById('user-name').value.trim();
    if(!db.participants[n]) db.participants[n] = { picks: {} };
    db.participants[name]; db.participants[n].picks[id] = o;
    save();
}

function setWinner(id, o) { db.results[id] = db.results[id] === o ? null : o; save(); }
function importUser() {
    const d = JSON.parse(decodeURIComponent(atob(document.getElementById('in-code').value.trim())));
    db.participants[d.n] = { picks: d.p, auto: d.a };
    save();
}
function generateCode() {
    const n = document.getElementById('user-name').value.trim();
    const c = btoa(encodeURIComponent(JSON.stringify({ n, p: db.participants[n].picks })));
    navigator.clipboard.writeText(c); alert("Copiato!");
}
function downloadPDF() { alert("Generazione PDF..."); }

render();
</script>
</body>
</html>