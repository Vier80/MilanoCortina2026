<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milano Cortina 2026 | Contest Ufficiale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f1f5f9; }
        .ita-gradient { background: linear-gradient(90deg, #008C45 0%, #ffffff 50%, #CD212A 100%); }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        
        /* 4 Colori Scelte */
        .btn-pick { border-width: 2px; transition: all 0.2s; font-weight: 700; }
        .active-a { background-color: #008C45 !important; color: white !important; border-color: #005c2d !important; }
        .active-b { background-color: #CD212A !important; color: white !important; border-color: #a01a21 !important; }
        .active-c { background-color: #004D99 !important; color: white !important; border-color: #003366 !important; }
        .active-field { background-color: #FFD700 !important; color: #000 !important; border-color: #bfa300 !important; }
        
        .card-ev { border-radius: 1.5rem; border-top: 6px solid #1e293b; transition: transform 0.3s; }
        .card-ev:hover { transform: translateY(-5px); }
        .hidden { display: none; }
    </style>
</head>
<body class="antialiased text-slate-900">

<div class="ita-gradient h-2 w-full fixed top-0 z-[100]"></div>

<nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200 shadow-sm h-20 flex items-center">
    <div class="max-w-7xl mx-auto px-4 w-full flex justify-between items-center">
        <div class="flex items-center gap-2">
            <span class="text-2xl">ðŸ‡®ðŸ‡¹</span>
            <h1 class="font-black text-xl tracking-tighter">MILANO CORTINA <span class="text-red-600">2026</span></h1>
        </div>
        <div class="flex bg-slate-100 p-1 rounded-2xl">
            <button onclick="location.reload()" class="px-5 py-2 rounded-xl font-bold text-xs text-slate-500 uppercase">Reset</button>
            <button onclick="switchTab('admin')" class="px-5 py-2 rounded-xl font-bold text-xs text-slate-500 uppercase hover:text-red-600">Admin</button>
        </div>
    </div>
</nav>

<div class="max-w-7xl mx-auto p-4 md:p-8">

    <div id="section-user">
        <div id="user-welcome" class="max-w-xl mx-auto mt-12 p-10 glass rounded-[2.5rem] shadow-2xl text-center space-y-8 border-b-8 border-green-600">
            <h2 class="text-4xl font-black uppercase italic leading-none">Sfida Olimpica <br><span class="text-red-600">2026</span></h2>
            <p class="text-slate-500 font-medium">Inserisci il tuo Nickname per iniziare il contest</p>
            <input type="text" id="user-name" placeholder="Nickname (es. Bomber ðŸ…)" 
                   class="w-full bg-slate-50 border-4 border-slate-100 p-5 rounded-2xl focus:border-green-600 outline-none font-black text-2xl text-center shadow-inner">
            <button onclick="startGame()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xl hover:bg-black transition-all shadow-xl uppercase">Gioca</button>
        </div>

        <div id="user-game" class="hidden space-y-8">
            <div class="glass p-6 rounded-3xl shadow-lg border-l-8 border-red-600 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <p class="text-[10px] font-black uppercase text-slate-400">Atleta in gara:</p>
                    <h3 id="display-name" class="text-2xl font-black italic"></h3>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="autoFillContest()" class="px-4 py-2 bg-slate-100 rounded-lg font-bold text-[10px] hover:bg-amber-100 uppercase">ðŸ¤– Auto-compila</button>
                    <button onclick="downloadPDF()" class="px-4 py-2 bg-slate-900 text-white rounded-lg font-bold text-[10px] uppercase">Esporta PDF</button>
                    <button onclick="generateCode()" class="px-6 py-2 bg-red-600 text-white rounded-lg font-black text-[10px] uppercase shadow-lg shadow-red-100">Copia Codice per Admin</button>
                </div>
            </div>
            <div id="events-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <div id="section-admin" class="hidden">
        <div id="admin-login" class="max-w-md mx-auto mt-20 p-8 glass rounded-3xl shadow-xl text-center space-y-4">
            <h2 class="font-black italic text-xl">Accesso Admin</h2>
            <input type="password" id="admin-pass" placeholder="Password" class="w-full p-4 border rounded-xl text-center font-bold outline-none focus:border-red-500">
            <button onclick="unlockAdmin()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold">Accedi</button>
            <button onclick="switchTab('user')" class="text-xs text-slate-400 underline">Torna al gioco</button>
        </div>

        <div id="admin-content" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-md border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black uppercase italic">Ranking</h3>
                        <button onclick="shareWhatsApp()" class="text-green-600 font-bold text-[10px] uppercase border border-green-200 px-2 py-1 rounded">WhatsApp</button>
                    </div>
                    <div id="ranking-list" class="space-y-2"></div>
                </div>
                <div class="bg-slate-900 text-white p-6 rounded-3xl space-y-4">
                    <button onclick="document.getElementById('xl-in').click()" class="w-full py-3 bg-slate-800 rounded-xl font-bold text-xs uppercase border border-slate-700">1. Carica Excel Eventi</button>
                    <input type="file" id="xl-in" class="hidden" accept=".xlsx, .xls">
                    <textarea id="in-code" placeholder="Incolla codice partecipante..." class="w-full h-24 bg-slate-800 border-slate-700 rounded-xl p-3 text-[10px] font-mono"></textarea>
                    <button onclick="importUser()" class="w-full py-3 bg-green-600 rounded-xl font-bold text-xs uppercase">2. Importa Partecipante</button>
                </div>
            </div>
            <div class="lg:col-span-8 bg-white p-6 rounded-3xl shadow-md border border-slate-100">
                <h3 class="font-black uppercase italic mb-6 border-b pb-4 text-slate-400 text-sm tracking-widest">Pannello Controllo Gare</h3>
                <div id="admin-events-list" class="space-y-6 max-h-[800px] overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>
</div>

<script>
const ADMIN_PASS = "cortina2026";
const POINTS = { a: 15, b: 18, c: 25, field: 10 };
let db = JSON.parse(localStorage.getItem('olympic_v4')) || { events: [], participants: {}, results: {} };

function save() { localStorage.setItem('olympic_v4', JSON.stringify(db)); render(); }

// --- GIOCO ---
function startGame() {
    const name = document.getElementById('user-name').value.trim();
    if(!name || db.events.length === 0) return alert("Inserisci il nome e assicurati che l'Admin abbia caricato gli eventi!");
    document.getElementById('user-welcome').classList.add('hidden');
    document.getElementById('user-game').classList.remove('hidden');
    document.getElementById('display-name').innerText = name;
    render();
}

// --- FIX EXCEL DATA ---
function excelDateToJS(serial) {
    if(!serial || isNaN(serial)) return serial; // Se Ã¨ giÃ  testo, restituisci testo
    const date = new Date(Math.round((serial - 25569) * 86400 * 1000));
    return date.toLocaleDateString('it-IT');
}

document.getElementById('xl-in').addEventListener('change', (e) => {
    const reader = new FileReader();
    reader.onload = (evt) => {
        const workbook = XLSX.read(evt.target.result, { type: 'binary' });
        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        
        const find = (r, keys) => {
            const match = Object.keys(r).find(k => keys.some(t => k.trim().toLowerCase().includes(t.toLowerCase())));
            return r[match] || '';
        };

        db.events = rows.map((r, i) => ({
            id: i + 1,
            date: excelDateToJS(find(r, ['data', 'giorno', 'date'])),
            sport: find(r, ['sport', 'disciplina']),
            name: find(r, ['evento', 'event', 'gara']),
            a: find(r, ['picking #a', 'scelta a', 'pick a']),
            b: find(r, ['picking #b', 'scelta b', 'pick b']),
            c: find(r, ['picking #c', 'scelta c', 'pick c']),
            field: find(r, ['field', 'altro'])
        }));
        save();
        alert("Caricati " + db.events.length + " eventi!");
    };
    reader.readAsBinaryString(e.target.files[0]);
});

// --- ADMIN ---
function switchTab(t) {
    document.getElementById('section-user').classList.toggle('hidden', t !== 'user');
    document.getElementById('section-admin').classList.toggle('hidden', t !== 'admin');
}

function unlockAdmin() {
    if(document.getElementById('admin-pass').value === ADMIN_PASS) {
        document.getElementById('admin-login').classList.add('hidden');
        document.getElementById('admin-content').classList.remove('hidden');
    } else alert("Password Errata");
}

function importUser() {
    try {
        const d = JSON.parse(decodeURIComponent(atob(document.getElementById('in-code').value.trim())));
        db.participants[d.n] = { picks: d.p, auto: d.a };
        document.getElementById('in-code').value = '';
        save();
    } catch(e) { alert("Codice invalido"); }
}

function delUser(n) { if(confirm("Eliminare "+n+"?")) { delete db.participants[n]; save(); } }

function setWinner(id, opt) { db.results[id] = (db.results[id] === opt) ? null : opt; save(); }

// --- RENDERING ---
function render() {
    const curName = document.getElementById('user-name').value.trim();
    const userPicks = db.participants[curName]?.picks || {};

    // Grid Utente
    document.getElementById('events-grid').innerHTML = db.events.map(ev => `
        <div class="card-ev bg-white p-6 shadow-sm border border-slate-100">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[9px] font-black text-slate-400 uppercase">${ev.sport}</span>
                <span class="text-[10px] text-red-600 font-black italic">${ev.date || '---'}</span>
            </div>
            <h4 class="font-bold text-slate-800 text-sm mb-4 h-10 overflow-hidden leading-tight">${ev.name}</h4>
            <div class="grid grid-cols-1 gap-2">
                ${['a','b','c','field'].map(o => {
                    const active = userPicks[ev.id] === o;
                    const cl = active ? 'active-'+o : 'bg-slate-50 text-slate-500';
                    return `<button onclick="makePick(${ev.id}, '${o}')" class="btn-pick p-3 rounded-xl text-[10px] flex justify-between items-center ${cl}">
                        <span class="truncate pr-2">${ev[o]}</span> <span class="text-[8px] opacity-60">${POINTS[o]}PT</span>
                    </button>`;
                }).join('')}
            </div>
        </div>
    `).join('');

    // Admin List
    document.getElementById('admin-events-list').innerHTML = db.events.map(ev => {
        const v = {a:[], b:[], c:[], field:[]};
        Object.keys(db.participants).forEach(n => {
            const pk = db.participants[n].picks[ev.id];
            if(pk) v[pk].push({n, a:db.participants[n].auto});
        });
        return `
        <div class="bg-slate-50 rounded-2xl border border-slate-200 overflow-hidden">
            <div class="p-4 bg-white flex justify-between items-center gap-4">
                <div class="flex-1 text-xs font-bold">${ev.name} <br><span class="text-slate-300 font-normal">${ev.date}</span></div>
                <div class="flex gap-1 bg-slate-100 p-1 rounded-lg">
                    ${['a','b','c','field'].map(o => `<button onclick="setWinner(${ev.id}, '${o}')" class="w-10 h-7 rounded font-black text-[9px] ${db.results[ev.id]===o?'bg-red-600 text-white':'text-slate-400'}">${o.toUpperCase()}</button>`).join('')}
                </div>
            </div>
            <div class="p-3 grid grid-cols-4 gap-2 text-[8px] border-t border-slate-100">
                ${['a','b','c','field'].map(o => `<div><b class="text-slate-400 uppercase">${o}:</b> <div class="flex flex-wrap gap-1 mt-1">${v[o].map(p=>`<span class="bg-white border px-1 rounded ${p.a?'text-amber-500':''}">${p.n}</span>`).join('')||'-'}</div></div>`).join('')}
            </div>
        </div>`;
    }).join('');

    // Ranking Admin
    const rnk = Object.keys(db.participants).map(n => {
        let s = 0;
        Object.keys(db.participants[n].picks).forEach(id => { if(db.results[id]===db.participants[n].picks[id]) s += POINTS[db.participants[n].picks[id]]; });
        return { n, s, a: db.participants[n].auto };
    }).sort((a,b) => b.s - a.s);

    document.getElementById('ranking-list').innerHTML = rnk.map((p,i) => `
        <div class="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 shadow-sm">
            <div class="flex items-center gap-2">
                <span class="font-black ${i<3?'text-red-600':'text-slate-300'} text-lg">#${i+1}</span>
                <div>
                    <div class="font-bold text-xs">${p.n} ${p.a?'ðŸ¤–':''}</div>
                    <button onclick="delUser('${p.n.replace(/'/g, "\\'")}')" class="text-[8px] text-red-400 font-black uppercase">Elimina</button>
                </div>
            </div>
            <div class="text-lg font-black text-green-600">${p.s}</div>
        </div>
    `).join('');
}

function makePick(id, o) {
    const n = document.getElementById('user-name').value.trim();
    if(!db.participants[n]) db.participants[n] = { picks: {}, auto: false };
    db.participants[n].picks[id] = o;
    save();
}

function autoFillContest() {
    const n = document.getElementById('user-name').value.trim();
    db.events.forEach(ev => {
        if(!db.participants[n]) db.participants[n] = { picks: {} };
        db.participants[n].picks[ev.id] = ['a','b','c','field'][Math.floor(Math.random()*4)];
    });
    db.participants[n].auto = true;
    save();
}

function generateCode() {
    const n = document.getElementById('user-name').value.trim();
    if(!n || !db.participants[n]) return alert("Fai le tue scelte!");
    const c = btoa(encodeURIComponent(JSON.stringify({ n, p: db.participants[n].picks, a: db.participants[n].auto })));
    navigator.clipboard.writeText(c);
    alert("Codice Copiato! Mandala all'Admin su WhatsApp ðŸ‡®ðŸ‡¹");
}

function shareWhatsApp() {
    const rnk = Object.keys(db.participants).map(n => {
        let s = 0;
        Object.keys(db.participants[n].picks).forEach(id => { if(db.results[id]===db.participants[n].picks[id]) s += POINTS[db.participants[n].picks[id]]; });
        return { n, s, a: db.participants[n].auto };
    }).sort((a,b) => b.s - a.s);
    let t = "*RANKING MILANO CORTINA 2026* ðŸ¥‡\n\n";
    rnk.forEach((p,i) => t += `${i+1}. *${p.n}*: ${p.s} pt ${p.a?'ðŸ¤–':''}\n`);
    navigator.clipboard.writeText(t).then(() => alert("Classifica copiata!"));
}

function downloadPDF() {
    const n = document.getElementById('user-name').value.trim();
    if(!n) return;
    const el = document.createElement('div');
    el.className = "p-10";
    el.innerHTML = `<h1 style="color:#CD212A; border-bottom:4px solid #008C45; padding-bottom:10px">MILANO CORTINA 2026</h1><p>Pronostici di: <b>${n}</b></p><br><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:10px">${db.events.map(ev => { const p = db.participants[n]?.picks[ev.id]; return p ? `<div style="padding:5px; border:1px solid #eee"><b>${ev.name}</b>: ${ev[p]}</div>` : ''; }).join('')}</div>`;
    html2pdf().from(el).save(`MC2026_${n}.pdf`);
}

render();
</script>
</body>
</html>